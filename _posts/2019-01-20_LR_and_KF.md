---
layout: post
title: "[Python] Linear Regression and Kalman Filter
subtitle: "선형회귀와 칼만필터"
author: "MK"
comments: true
sitemap :
  changefreq : daily
  priority : 1.0
tags: [시계열분석]
---



칼만필터는 공간선형모델로 주로, 네비게이션에서 위치를 추적하는데 쓰이거나 미사일 위치를 추적하는 등 관측치를 기반으로 현재의 상태를 예측하는데 활용되는 모델이다.

이에 따라 경제학 분야에서도 랜덤하게 변화는 상태에서 가장 확률적으로 가능성이 높은 예측 상태를 추적하기 위해 활용되었는데 환율예측이나 주가예측 등 다양한 연구사례들이 있다.

현재는 인공지능의 발달로 RNN과 대조되어 사용되기도 하지만, 각각의 특장점이 있어 여전히 많이 쓰이고 있는 칼만 필터에 대해 인지하고 넘어가야할 필요가 있다.


x~k+1~ = A~k~x~k~ + w~k~
z~k~ = H~k~x~k~ + v~k~

x~k~와 z~k~는 시각 k에서 숨겨진 상태와 관측 벡터이다.
A~k~와 H~k~는 전이행렬(일종의 함수)를 의미한다.
w~k~와 v~k~는 평균이 0인 가우시안 잡음이다.

관측치를 기반으로 얻는 주가의 조정 종가를 z~k~라 할때 행렬 H는 마감가격과 조정마감가격으로 구성된 1X2 벡터이다. 이 자체가 단순히 두 Asset 사이에서의 선형 회귀이다.

응용하여 숨겨진 상태변수 x~k~가 β로 표시된 선형회귀로 이루어진다고 가정한다. 또한 행렬 A를 랜덤워크로 가정하여 아래와 같은 산식으로 재구성한다.


β~k+1~ = Iβ~k~ + w~k~

다시 말해 다음 스텝을 위한 β는 현재의 β와 약간의 잡음을 포함하는 개념이다.

이제 칼만필터의 관측 방적식을 통해 2개의 주가의 spread를 분석해보자!


### 1. 데이터 가져오기
```python
import matplotlib.pyplot as plt
import seaborn as sns; sns.set()
import pandas as pd
import numpy as np
from pykalman import KalmanFilter
import statsmodels
import statsmodels.api as sm
```
KRX에서 제공하는 MarketData를 통해 5개년 종목 시세를 CSV로 저장해 두었다.
http://marketdata.krx.co.kr/mdi#document=13020101

데이터리더를 통해 주가 데이터를 가져온다.
```python

```

### 2. 종목 살펴보기
수익률 추이 살펴보기
pct_change는 pandas에서 제공하는 변화률 계산 함수이다.

```python
cumm_rtn = (1 + data.pct_change()).cumprod()
cumm_rtn.plot()
plt.ylabel('Cumulative Return')
plt.xlabel('Time')
title = 'Cummulative Plot of ' + tickers[0] + 'and ' + tickers[1]
plt.title(title)
```


![img_area](/img/posting/2019-01-20-001-kf.PNG){: .post-img}


두 종목의 종가 비교 그래프
```python
colors = np.linspace(0.1, 1, len(data))
sc = plt.scatter(data[tickers[0]], data[tickers[1]], s=30,
                 c=colors, cmap=plt.get_cmap('jet'), edgecolor='k', alpha=0.7)
cb = plt.colorbar(sc)
cb.ax.set_yticklabels(['t' for p in data[::len(data)//9].index])
plt.xlabel(stock1_nm)
plt.ylabel(stock2_nm)
```


kf = KalmanFilter(n_dim_obs=1, n_dim_state=2,
                  initial_state_mean=np.zeros(2),
                  initial_state_covariance=np.ones((2, 2)),
                  transition_matrices=np.eye(2),
                  observation_matrices=obs_mat,
                  observation_covariance=1.0,
                  transition_covariance=trans_cov)
```



http://www.thealgoengineer.com/2014/online_linear_regression_kalman_filter/
